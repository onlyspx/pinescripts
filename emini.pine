//@version=5
indicator("eminiplayer zones", overlay=true, max_bars_back=1000)

// Market Settings
indexarb = input.int(37, title="ES - SPX", minval=0, maxval=100)

// Price Levels Input
textarea = input.text_area(defval = "", title = "ES daily levels")

// VWAP Settings
show_vwap = input.bool(false, title="Show VWAP", group="Indicators")
vwap_color = input.color(color.new(color.yellow, 50), title="VWAP Color", group="Indicators")

// EMA Settings
show_ema = input.bool(false, title="Show EMA", group="Indicators", inline="ema")
ema_length = input.int(21, title="Length", minval=1, group="Indicators", inline="ema")
ema_color = input.color(color.new(color.blue, 50), title="Color", group="Indicators", inline="ema")

// 1-Hour High/Low Settings
show_1hr = input.bool(false, title="Show 1HR High/Low with Extensions", group="1HR Levels")

// Market Detection and Multiplier Logic
IsUS500 = syminfo.root == "US500"
IsSPX   = syminfo.root == "SPX" or IsUS500
IsES    = syminfo.root == "ES" or syminfo.root == "MES"
m       = IsSPX ? indexarb : IsES ? 1 : na

// Session Detection (using exchange timezone)
newSession = ta.change(time("D"))
sessionSpec = (IsES or IsUS500) ? "0830-1500" : "0930-1600"
sessionTime = time(timeframe.period, sessionSpec)
isSessionBar = not na(sessionTime)
isSessionStart = isSessionBar and na(sessionTime[1])

// Track session start index and timestamp
var int session_start_bar = na
var int session_start_time = na

if newSession
    session_start_bar := na
    session_start_time := na

if isSessionStart
    session_start_bar := bar_index
    session_start_time := time

// Session duration in minutes (9:30 AM to 4:00 PM = 390 minutes)
sessionMinutes = 390
right = sessionMinutes / timeframe.multiplier

// 1-Hour High/Low Tracking (first hour of session: 9:30 AM - 10:30 AM)
var float hr1_high = na
var float hr1_low = na

// Determine if current bar falls within the first hour of the regular session
in_1hr_period = isSessionBar and not na(session_start_time) and (time - session_start_time) < 60 * 60 * 1000

// Reset tracking on new day or when a fresh session starts
if newSession or isSessionStart
    hr1_high := na
    hr1_low := na

// Track high/low during first hour
if in_1hr_period
    hr1_high := na(hr1_high) ? high : math.max(high, hr1_high)
    hr1_low := na(hr1_low) ? low : math.min(low, hr1_low)

// Calculate 1HR range and extensions
hr1_range = hr1_high - hr1_low
hr1_high_050 = hr1_high + (hr1_range * 0.5)
hr1_high_100 = hr1_high + (hr1_range * 1.0)
hr1_low_050 = hr1_low - (hr1_range * 0.5)
hr1_low_100 = hr1_low - (hr1_range * 1.0)

// Check if today (only show lines for current day)
isToday = year(timenow) == year(time) and month(timenow) == month(time) and dayofmonth(timenow) == dayofmonth(time)

// Process Price Levels and Create Zones (Only on intraday timeframes)
if timeframe.isintraday
    lines = str.split(textarea, "\n")
    for i = 0 to array.size(lines) - 1
        line = array.get(lines, i)
        columns = str.split(line, ",")
        
        // Skip lines that don't have at least 4 columns
        if array.size(columns) < 4
            continue
        
        price_low = str.tonumber(array.get(columns, 0))
        price_high = str.tonumber(array.get(columns, 1))
        zone_type = array.get(columns, 3)

        if na(price_low) or na(price_high)
            continue
        
        zone_top = IsSPX ? price_high - m : IsES ? price_high : na
        zone_bottom = IsSPX ? price_low - m : IsES ? price_low : na

        if na(zone_top) or na(zone_bottom)
            continue
        
        // Only show zones within 50 points of current price
        zone_distance_from_price = math.min(math.abs(close - zone_top), math.abs(close - zone_bottom))
        show_zone = zone_distance_from_price <= 50 or (close >= zone_bottom and close <= zone_top)
        
        if show_zone and not na(session_start_bar)
            border_color = close > zone_top ? color.green : close < zone_bottom ? color.red : color.white
            bg_color = close > zone_top ? color.new(color.green, 99) : close < zone_bottom ? color.new(color.red, 99) : color.new(color.white, 99)
            
            box.new(session_start_bar, zone_top, session_start_bar + right, zone_bottom, 
                 border_color=border_color, 
                 bgcolor=bg_color, 
                 text_color=color.white, 
                 text=zone_type,
                 text_size=size.normal,
                 text_halign=text.align_center)

// Plot VWAP (Session-based)
vwap_value = ta.vwap(close, newSession)
plot(show_vwap ? vwap_value : na, title="VWAP", color=vwap_color, linewidth=2, style=plot.style_circles)

// Plot EMA
ema_value = ta.ema(close, ema_length)
plot(show_ema ? ema_value : na, title="EMA", color=ema_color, linewidth=2)

// Plot 1HR High/Low and Extensions (only after 1hr period, on intraday timeframes, for today only)
show_1hr_lines = show_1hr and not in_1hr_period and timeframe.isintraday and isToday and not na(hr1_high) and not na(hr1_low)

var line line_hr1_high = na
var line line_hr1_low = na
var line line_hr1_high_050 = na
var line line_hr1_high_100 = na
var line line_hr1_low_050 = na
var line line_hr1_low_100 = na

var label label_hr1_high = na
var label label_hr1_low = na
var label label_hr1_high_050 = na
var label label_hr1_high_100 = na
var label label_hr1_low_050 = na
var label label_hr1_low_100 = na

// Reset on new day
if newSession and show_1hr
    if not na(line_hr1_high)
        line.delete(line_hr1_high)
        line.delete(line_hr1_low)
        line.delete(line_hr1_high_050)
        line.delete(line_hr1_high_100)
        line.delete(line_hr1_low_050)
        line.delete(line_hr1_low_100)
    if not na(label_hr1_high)
        label.delete(label_hr1_high)
        label.delete(label_hr1_low)
        label.delete(label_hr1_high_050)
        label.delete(label_hr1_high_100)
        label.delete(label_hr1_low_050)
        label.delete(label_hr1_low_100)

// Create/Update lines and labels when 1hr period ends
if show_1hr_lines and not na(session_start_bar)
    // Calculate line end position (extend to market close, same as zones)
    line_end = session_start_bar + right
    
    if na(line_hr1_high)
        line_hr1_high := line.new(session_start_bar, hr1_high, line_end, hr1_high, color=color.green, width=1)
        label_hr1_high := label.new(bar_index, hr1_high, text="1HR High (Range: " + str.tostring(hr1_range, "#.##") + ")", style=label.style_label_left, color=color.green, textcolor=color.white)
        
        line_hr1_low := line.new(session_start_bar, hr1_low, line_end, hr1_low, color=color.red, width=1)
        label_hr1_low := label.new(bar_index, hr1_low, text="1HR Low", style=label.style_label_left, color=color.red, textcolor=color.white)
        
        line_hr1_high_050 := line.new(session_start_bar, hr1_high_050, line_end, hr1_high_050, color=color.orange, width=1)
        label_hr1_high_050 := label.new(bar_index, hr1_high_050, text="0.5x High", style=label.style_label_left, color=color.orange, textcolor=color.white)
        
        line_hr1_high_100 := line.new(session_start_bar, hr1_high_100, line_end, hr1_high_100, color=color.purple, width=1)
        label_hr1_high_100 := label.new(bar_index, hr1_high_100, text="1.0x High", style=label.style_label_left, color=color.purple, textcolor=color.white)
        
        line_hr1_low_050 := line.new(session_start_bar, hr1_low_050, line_end, hr1_low_050, color=color.orange, width=1)
        label_hr1_low_050 := label.new(bar_index, hr1_low_050, text="0.5x Low", style=label.style_label_left, color=color.orange, textcolor=color.white)
        
        line_hr1_low_100 := line.new(session_start_bar, hr1_low_100, line_end, hr1_low_100, color=color.purple, width=1)
        label_hr1_low_100 := label.new(bar_index, hr1_low_100, text="1.0x Low", style=label.style_label_left, color=color.purple, textcolor=color.white)
    else
        line.set_x2(line_hr1_high, line_end)
        label.set_xy(label_hr1_high, bar_index, hr1_high)
        label.set_text(label_hr1_high, "1HR High (Range: " + str.tostring(hr1_range, "#.##") + ")")
        
        line.set_x2(line_hr1_low, line_end)
        label.set_xy(label_hr1_low, bar_index, hr1_low)
        
        line.set_x2(line_hr1_high_050, line_end)
        label.set_xy(label_hr1_high_050, bar_index, hr1_high_050)
        
        line.set_x2(line_hr1_high_100, line_end)
        label.set_xy(label_hr1_high_100, bar_index, hr1_high_100)
        
        line.set_x2(line_hr1_low_050, line_end)
        label.set_xy(label_hr1_low_050, bar_index, hr1_low_050)
        
        line.set_x2(line_hr1_low_100, line_end)
        label.set_xy(label_hr1_low_100, bar_index, hr1_low_100)
